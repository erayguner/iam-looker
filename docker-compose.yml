---
version: '3.8'

services:
  # Development environment
  dev:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: iam-looker-dev
    volumes:
      - .:/app
      - pip-cache:/root/.cache/pip
      - pre-commit-cache:/root/.cache/pre-commit
    environment:
      - PYTHONPATH=/app/src
      - LOOKERSDK_BASE_URL=${LOOKERSDK_BASE_URL:-}
      - LOOKERSDK_CLIENT_ID=${LOOKERSDK_CLIENT_ID:-}
      - LOOKERSDK_CLIENT_SECRET=${LOOKERSDK_CLIENT_SECRET:-}
      - LOOKERSDK_VERIFY_SSL=${LOOKERSDK_VERIFY_SSL:-true}
    env_file:
      - .env
    working_dir: /app
    command: /bin/bash
    stdin_open: true
    tty: true
    networks:
      - iam-looker-network

  # Production-like environment for testing
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: iam-looker-app
    volumes:
      - ./config:/app/config:ro
    environment:
      - PYTHONPATH=/app/src
      - LOOKERSDK_BASE_URL=${LOOKERSDK_BASE_URL:-}
      - LOOKERSDK_CLIENT_ID=${LOOKERSDK_CLIENT_ID:-}
      - LOOKERSDK_CLIENT_SECRET=${LOOKERSDK_CLIENT_SECRET:-}
      - LOOKERSDK_VERIFY_SSL=${LOOKERSDK_VERIFY_SSL:-true}
    env_file:
      - .env
    ports:
      - "8080:8080"
    networks:
      - iam-looker-network
    restart: unless-stopped

  # Test runner
  test:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: iam-looker-test
    volumes:
      - .:/app
      - test-reports:/app/test-reports
      - coverage-reports:/app/htmlcov
    environment:
      - PYTHONPATH=/app/src
    command: >
      bash -c "pytest -v --cov --cov-report=html --cov-report=term"
    networks:
      - iam-looker-network

  # Terraform operations
  terraform:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: iam-looker-terraform
    volumes:
      - ./terraform:/app/terraform
      - terraform-plugins:/root/.terraform.d/plugins
    working_dir: /app/terraform
    environment:
      - TF_IN_AUTOMATION=true
    command: terraform --version
    networks:
      - iam-looker-network

volumes:
  pip-cache:
    name: iam-looker-pip-cache
  pre-commit-cache:
    name: iam-looker-pre-commit-cache
  test-reports:
    name: iam-looker-test-reports
  coverage-reports:
    name: iam-looker-coverage-reports
  terraform-plugins:
    name: iam-looker-terraform-plugins

networks:
  iam-looker-network:
    name: iam-looker-network
    driver: bridge
