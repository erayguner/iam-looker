name: PR Comment - CI Results

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

permissions:
  pull-requests: write
  contents: read
  actions: read

jobs:
  comment:
    name: Post CI Results to PR
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.conclusion != 'cancelled'

    steps:
      - name: Download PR number artifact
        uses: actions/github-script@v8
        id: get-pr
        with:
          script: |
            const allArtifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id,
            });

            const artifacts = allArtifacts.data.artifacts;
            console.log(`Found ${artifacts.length} artifacts`);

            // Get PR number from the workflow run
            const prNumber = context.payload.workflow_run.pull_requests[0]?.number;
            if (prNumber) {
              console.log(`PR Number: ${prNumber}`);
              return prNumber;
            }

            console.log('No PR found');
            return null;

      - name: Get workflow run jobs
        uses: actions/github-script@v8
        id: get-jobs
        with:
          script: |
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id,
            });

            const jobResults = jobs.data.jobs.map(job => ({
              name: job.name,
              status: job.conclusion,
              duration: Math.round((new Date(job.completed_at) - new Date(job.started_at)) / 1000),
              url: job.html_url
            }));

            return jobResults;

      - name: Create PR comment
        uses: actions/github-script@v8
        if: steps.get-pr.outputs.result != 'null'
        with:
          script: |
            const prNumber = ${{ steps.get-pr.outputs.result }};
            if (!prNumber) {
              console.log('No PR number found, skipping comment');
              return;
            }

            const jobs = ${{ steps.get-jobs.outputs.result }};
            const runUrl = context.payload.workflow_run.html_url;
            const conclusion = context.payload.workflow_run.conclusion;
            const commitSha = context.payload.workflow_run.head_sha.substring(0, 7);
            const branch = context.payload.workflow_run.head_branch;

            // Status emoji
            const statusEmoji = {
              'success': '‚úÖ',
              'failure': '‚ùå',
              'cancelled': '‚ö†Ô∏è',
              'skipped': '‚è≠Ô∏è'
            };

            const overallStatus = statusEmoji[conclusion] || '‚ùì';

            // Build job results table
            let jobsTable = '| Job | Status | Duration |\n';
            jobsTable += '|-----|--------|----------|\n';

            jobs.forEach(job => {
              const emoji = statusEmoji[job.status] || '‚ùì';
              const duration = job.duration ? `${job.duration}s` : 'N/A';
              const jobLink = `[${job.name}](${job.url})`;
              jobsTable += `| ${jobLink} | ${emoji} ${job.status} | ${duration} |\n`;
            });

            // Count results
            const successCount = jobs.filter(j => j.status === 'success').length;
            const failureCount = jobs.filter(j => j.status === 'failure').length;
            const totalCount = jobs.length;

            // Build comment body
            let commentBody = '## ' + overallStatus + ' CI Results\n\n';
            commentBody += '**Commit:** `' + commitSha + '` on `' + branch + '`\n';
            commentBody += '**Status:** ' + conclusion.toUpperCase() + '\n';
            commentBody += '**Results:** ' + successCount + '/' + totalCount + ' jobs passed\n\n';
            commentBody += '### üìä Job Results\n\n';
            commentBody += jobsTable + '\n';
            commentBody += '### üìù Summary\n\n';
            commentBody += failureCount > 0 ? '‚ö†Ô∏è **' + failureCount + ' job(s) failed** - Please review the logs above.' : '‚úÖ All checks passed successfully!';
            commentBody += '\n\n---\n';
            commentBody += '<details>\n';
            commentBody += '<summary>üîó View Details</summary>\n\n';
            commentBody += '- [Full Workflow Run](' + runUrl + ')\n';
            commentBody += '- Triggered by: ' + context.payload.workflow_run.event + '\n';
            commentBody += '- Started at: ' + new Date(context.payload.workflow_run.created_at).toLocaleString() + '\n';
            commentBody += '- Completed at: ' + new Date(context.payload.workflow_run.updated_at).toLocaleString() + '\n\n';
            commentBody += '</details>\n\n';
            commentBody += '<!-- ci-results-comment -->';

            // Find existing comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const botComment = comments.data.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('<!-- ci-results-comment -->')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
              console.log('Updated existing comment');
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: commentBody
              });
              console.log('Created new comment');
            }
