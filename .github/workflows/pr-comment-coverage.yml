name: PR Comment - Test Coverage

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

permissions:
  pull-requests: write
  contents: read
  actions: read

jobs:
  coverage-comment:
    name: Post Coverage Report to PR
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.conclusion == 'success'

    steps:
      - name: Download coverage artifact
        uses: actions/github-script@v8
        id: download-artifact
        continue-on-error: true
        with:
          script: |
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id,
            });

            const coverageArtifact = artifacts.data.artifacts.find(
              artifact => artifact.name.includes('coverage-report-html')
            );

            if (coverageArtifact) {
              const download = await github.rest.actions.downloadArtifact({
                owner: context.repo.owner,
                repo: context.repo.repo,
                artifact_id: coverageArtifact.id,
                archive_format: 'zip',
              });

              const fs = require('fs');
              fs.writeFileSync('coverage.zip', Buffer.from(download.data));
              return true;
            }

            return false;

      - name: Extract coverage data
        if: steps.download-artifact.outputs.result == 'true'
        continue-on-error: true
        run: |
          unzip -q coverage.zip -d coverage || true
          if [ -f coverage/index.html ]; then
            # Extract coverage percentage from HTML
            COVERAGE=$(grep -oP '\d+%' coverage/index.html | head -1 | tr -d '%')
            echo "COVERAGE_PERCENT=$COVERAGE" >> $GITHUB_ENV
            echo "Coverage: $COVERAGE%"
          fi

      - name: Get PR number
        uses: actions/github-script@v8
        id: get-pr
        with:
          script: |
            const prNumber = context.payload.workflow_run.pull_requests[0]?.number;
            return prNumber || null;

      - name: Post coverage comment
        uses: actions/github-script@v8
        if: steps.get-pr.outputs.result != 'null' && env.COVERAGE_PERCENT
        with:
          script: |
            const prNumber = ${{ steps.get-pr.outputs.result }};
            if (!prNumber) {
              console.log('No PR number found');
              return;
            }

            const coverage = process.env.COVERAGE_PERCENT || 'N/A';
            const coverageNum = parseFloat(coverage);
            const runUrl = context.payload.workflow_run.html_url;
            const commitSha = context.payload.workflow_run.head_sha.substring(0, 7);

            // Coverage emoji based on percentage
            let coverageEmoji = '‚úÖ';
            let coverageColor = 'green';
            if (coverageNum < 80) {
              coverageEmoji = '‚ö†Ô∏è';
              coverageColor = 'yellow';
            }
            if (coverageNum < 60) {
              coverageEmoji = '‚ùå';
              coverageColor = 'red';
            }

            // Build coverage badge
            const badgeUrl = `https://img.shields.io/badge/coverage-${coverage}%25-${coverageColor}`;

            let commentBody = '## ' + coverageEmoji + ' Test Coverage Report\n\n';
            commentBody += '**Commit:** `' + commitSha + '`\n';
            commentBody += '**Coverage:** ![Coverage](' + badgeUrl + ')\n\n';
            commentBody += '### üìä Coverage Summary\n\n';
            commentBody += '| Metric | Value |\n';
            commentBody += '|--------|-------|\n';
            commentBody += '| Total Coverage | **' + coverage + '%** |\n';
            commentBody += '| Threshold | 80% |\n';
            commentBody += '| Status | ' + (coverageNum >= 80 ? '‚úÖ Passing' : '‚ö†Ô∏è Below threshold') + ' |\n\n';

            if (coverageNum < 80) {
              commentBody += '### ‚ö†Ô∏è Coverage Warning\n\n';
              commentBody += 'Current coverage is **' + coverage + '%**, which is below the 80% threshold.\n';
              commentBody += 'Please add tests to improve coverage before merging.\n\n';
            }

            commentBody += '---\n';
            commentBody += '<details>\n';
            commentBody += '<summary>üìà How to improve coverage</summary>\n\n';
            commentBody += '1. Run `make test-cov` locally to see coverage report\n';
            commentBody += '2. Open `htmlcov/index.html` to see which lines need coverage\n';
            commentBody += '3. Add tests for uncovered code paths\n';
            commentBody += '4. Aim for meaningful tests, not just coverage numbers\n\n';
            commentBody += '</details>\n\n';
            commentBody += '[View Full Report](' + runUrl + ')\n\n';
            commentBody += '<!-- coverage-comment -->';

            // Find existing comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const botComment = comments.data.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('<!-- coverage-comment -->')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
              console.log('Updated coverage comment');
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: commentBody
              });
              console.log('Created coverage comment');
            }
