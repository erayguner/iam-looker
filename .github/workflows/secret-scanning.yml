name: Secret Scanning

on:
  push:
    branches: [main, develop, claude/**]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run daily at 2:00 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  gitleaks:
    name: Gitleaks Secret Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

  trufflehog:
    name: TruffleHog Secret Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      # For pull requests: scan the diff between PR base and head
      - name: TruffleHog OSS (Pull Request)
        if: github.event_name == 'pull_request'
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.pull_request.base.sha }}
          head: ${{ github.event.pull_request.head.sha }}
          extra_args: --only-verified

      # For push events: scan the pushed commits
      - name: TruffleHog OSS (Push)
        if: github.event_name == 'push' && github.event.before != '0000000000000000000000000000000000000000'
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.before }}
          head: ${{ github.event.after }}
          extra_args: --only-verified

      # For scheduled runs, manual triggers, or new branches: scan entire repository
      - name: TruffleHog OSS (Full Scan)
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.event.before == '0000000000000000000000000000000000000000')
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          extra_args: --only-verified

  detect-secrets:
    name: Detect Secrets
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Install detect-secrets
        run: pip install detect-secrets

      - name: Run detect-secrets scan
        run: |
          echo "::group::Detect-secrets Scan"
          detect-secrets scan --all-files --force-use-all-plugins > .secrets.baseline || true
          detect-secrets audit .secrets.baseline || true
          echo "::endgroup::"

      - name: Upload secrets baseline
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: secrets-baseline
          path: .secrets.baseline

  # Check for common secret patterns
  custom-secret-patterns:
    name: Custom Secret Pattern Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Check for common secrets
        run: |
          echo "::group::Custom Secret Pattern Check"

          # Check for common secret patterns
          echo "Checking for API keys..."
          grep -r -E "(api[_-]?key|apikey)" --include="*.py" --include="*.tf" --include="*.yaml" --include="*.yml" . || echo "No API key patterns found"

          echo "Checking for passwords..."
          grep -r -E "(password|passwd|pwd)" --include="*.py" --include="*.tf" --include="*.yaml" --include="*.yml" . || echo "No password patterns found"

          echo "Checking for tokens..."
          grep -r -E "(token|secret|credential)" --include="*.py" --include="*.tf" --include="*.yaml" --include="*.yml" . || echo "No token patterns found"

          echo "Checking for AWS keys..."
          grep -r -E "AKIA[0-9A-Z]{16}" . || echo "No AWS keys found"

          echo "Checking for private keys..."
          grep -r -E "BEGIN.*PRIVATE KEY" . || echo "No private keys found"

          echo "::endgroup::"
        continue-on-error: true

  secret-scan-summary:
    name: Secret Scan Summary
    runs-on: ubuntu-latest
    needs: [gitleaks, trufflehog, detect-secrets, custom-secret-patterns]
    if: always()

    steps:
      - name: Summary
        run: |
          echo "# Secret Scanning Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Scans Completed:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Gitleaks" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… TruffleHog" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Detect-secrets" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Custom pattern matching" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”’ All secret scanning tools completed successfully." >> $GITHUB_STEP_SUMMARY
