name: Deploy Cloud Functions

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'functions/**'
      - 'functions/**'
      - 'requirements.txt'
      - 'pyproject.toml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - development
          - staging
          - production
        default: 'development'
      deploy_all:
        description: 'Deploy all functions'
        required: false
        type: boolean
        default: true

permissions:
  contents: read
  id-token: write

env:
  PYTHON_VERSION: "3.12"
  GCP_REGION: "us-central1"

jobs:
  prepare:
    name: Prepare Deployment
    runs-on: ubuntu-latest
    outputs:
      deploy_env: ${{ steps.set-env.outputs.environment }}
      project_id: ${{ steps.set-env.outputs.project_id }}
      should_deploy: ${{ steps.set-env.outputs.should_deploy }}

    steps:
      - name: Set environment
        id: set-env
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            ENV="${{ github.event.inputs.environment }}"
          else
            ENV="development"
          fi

          echo "environment=$ENV" >> $GITHUB_OUTPUT

          case $ENV in
            production)
              echo "project_id=${{ secrets.GCP_PROJECT_ID_PROD }}" >> $GITHUB_OUTPUT
              ;;
            staging)
              echo "project_id=${{ secrets.GCP_PROJECT_ID_STAGING }}" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "project_id=${{ secrets.GCP_PROJECT_ID_DEV }}" >> $GITHUB_OUTPUT
              ;;
          esac

          echo "should_deploy=true" >> $GITHUB_OUTPUT

  deploy-functions:
    name: Deploy Cloud Functions (${{ needs.prepare.outputs.deploy_env }})
    runs-on: ubuntu-latest
    needs: prepare
    if: needs.prepare.outputs.should_deploy == 'true'
    timeout-minutes: 30
    environment:
      name: ${{ needs.prepare.outputs.deploy_env }}
      url: https://console.cloud.google.com/functions/list?project=${{ needs.prepare.outputs.project_id }}

    strategy:
      matrix:
        function:
          - name: looker-provision-all
            entry_point: provision_looker_project
            source_dir: functions
            description: "Complete Looker provisioning orchestration"
          - name: looker-add-group-saml
            entry_point: add_group_to_saml
            source_dir: functions
            description: "Add group to SAML configuration"
          - name: looker-create-folder
            entry_point: create_project_folder
            source_dir: functions
            description: "Create Looker project folder"
          - name: looker-clone-dashboard
            entry_point: create_dashboard_from_template
            source_dir: functions
            description: "Clone dashboard from template"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        if: secrets.WIF_PROVIDER != '' && secrets.WIF_SERVICE_ACCOUNT != ''
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v3
        with:
          project_id: ${{ needs.prepare.outputs.project_id }}

      - name: Create deployment package
        run: |
          mkdir -p deployment
          cp -r src deployment/
          cp -r ${{ matrix.function.source_dir }} deployment/
          cp requirements.txt deployment/
          echo "Deployment package created for ${{ matrix.function.name }}"

      - name: Get Looker secrets from Secret Manager
        id: secrets
        run: |
          # Fetch secrets (names will be created in Secret Manager)
          LOOKER_URL=$(gcloud secrets versions access latest --secret="looker-base-url" --project=${{ needs.prepare.outputs.project_id }} || echo "")
          LOOKER_CLIENT_ID=$(gcloud secrets versions access latest --secret="looker-client-id" --project=${{ needs.prepare.outputs.project_id }} || echo "")
          LOOKER_CLIENT_SECRET=$(gcloud secrets versions access latest --secret="looker-client-secret" --project=${{ needs.prepare.outputs.project_id }} || echo "")

          echo "::add-mask::$LOOKER_CLIENT_ID"
          echo "::add-mask::$LOOKER_CLIENT_SECRET"

          echo "secrets_exist=$([[ -n \"$LOOKER_URL\" ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT

      - name: Deploy Cloud Function
        run: |
          gcloud functions deploy ${{ matrix.function.name }} \
            --gen2 \
            --runtime=python312 \
            --region=${{ env.GCP_REGION }} \
            --source=deployment \
            --entry-point=${{ matrix.function.entry_point }} \
            --trigger-topic=looker-provisioning \
            --service-account=${{ secrets.CLOUD_FUNCTION_SA }}@${{ needs.prepare.outputs.project_id }}.iam.gserviceaccount.com \
            --memory=512MB \
            --timeout=540s \
            --max-instances=10 \
            --min-instances=0 \
            --ingress-settings=internal-only \
            --set-secrets=LOOKERSDK_BASE_URL=looker-base-url:latest,LOOKERSDK_CLIENT_ID=looker-client-id:latest,LOOKERSDK_CLIENT_SECRET=looker-client-secret:latest \
            --set-env-vars=LOOKERSDK_VERIFY_SSL=true,PYTHON_ENV=${{ needs.prepare.outputs.deploy_env }} \
            --description="${{ matrix.function.description }}" \
            --labels=env=${{ needs.prepare.outputs.deploy_env }},managed-by=github-actions,app=iam-looker
        continue-on-error: false

      - name: Verify deployment
        run: |
          echo "Verifying ${{ matrix.function.name }} deployment..."
          gcloud functions describe ${{ matrix.function.name }} \
            --gen2 \
            --region=${{ env.GCP_REGION }} \
            --project=${{ needs.prepare.outputs.project_id }}

  deploy-http-functions:
    name: Deploy HTTP Cloud Functions (${{ needs.prepare.outputs.deploy_env }})
    runs-on: ubuntu-latest
    needs: prepare
    if: needs.prepare.outputs.should_deploy == 'true'
    timeout-minutes: 30
    environment:
      name: ${{ needs.prepare.outputs.deploy_env }}

    strategy:
      matrix:
        function:
          - name: looker-http-provision
            entry_point: provision_looker_project
            source_dir: functions
            description: "HTTP endpoint for Looker provisioning"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        if: secrets.WIF_PROVIDER != '' && secrets.WIF_SERVICE_ACCOUNT != ''
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v3
        with:
          project_id: ${{ needs.prepare.outputs.project_id }}

      - name: Create deployment package
        run: |
          mkdir -p deployment
          cp -r src deployment/
          cp -r ${{ matrix.function.source_dir }} deployment/
          cp requirements.txt deployment/

      - name: Deploy HTTP Cloud Function
        run: |
          gcloud functions deploy ${{ matrix.function.name }} \
            --gen2 \
            --runtime=python312 \
            --region=${{ env.GCP_REGION }} \
            --source=deployment \
            --entry-point=${{ matrix.function.entry_point }} \
            --trigger-http \
            --service-account=${{ secrets.CLOUD_FUNCTION_SA }}@${{ needs.prepare.outputs.project_id }}.iam.gserviceaccount.com \
            --memory=512MB \
            --timeout=540s \
            --max-instances=10 \
            --ingress-settings=internal-only \
            --set-secrets=LOOKERSDK_BASE_URL=looker-base-url:latest,LOOKERSDK_CLIENT_ID=looker-client-id:latest,LOOKERSDK_CLIENT_SECRET=looker-client-secret:latest \
            --set-env-vars=LOOKERSDK_VERIFY_SSL=true,PYTHON_ENV=${{ needs.prepare.outputs.deploy_env }} \
            --description="${{ matrix.function.description }}" \
            --labels=env=${{ needs.prepare.outputs.deploy_env }},managed-by=github-actions,app=iam-looker,type=http

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [prepare, deploy-functions, deploy-http-functions]
    if: always()

    steps:
      - name: Check deployment status
        run: |
          if [[ "${{ needs.deploy-functions.result }}" == "success" ]] && \
             [[ "${{ needs.deploy-http-functions.result }}" == "success" ]]; then
            echo "âœ… All Cloud Functions deployed successfully to ${{ needs.prepare.outputs.deploy_env }}"
            exit 0
          else
            echo "âŒ Some deployments failed"
            echo "Pub/Sub Functions: ${{ needs.deploy-functions.result }}"
            echo "HTTP Functions: ${{ needs.deploy-http-functions.result }}"
            exit 1
          fi

      - name: Create deployment summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## ðŸš€ Deployment Summary

          **Environment:** \`${{ needs.prepare.outputs.deploy_env }}\`
          **Project ID:** \`${{ needs.prepare.outputs.project_id }}\`
          **Region:** \`${{ env.GCP_REGION }}\`

          ### Deployment Status
          - Pub/Sub Functions: ${{ needs.deploy-functions.result == 'success' && 'âœ…' || 'âŒ' }}
          - HTTP Functions: ${{ needs.deploy-http-functions.result == 'success' && 'âœ…' || 'âŒ' }}

          ### Deployed Functions
          - \`looker-provision-all\`
          - \`looker-add-group-saml\`
          - \`looker-create-folder\`
          - \`looker-clone-dashboard\`
          - \`looker-http-provision\`

          **Deployed at:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          **Commit SHA:** \`${{ github.sha }}\`
          EOF
