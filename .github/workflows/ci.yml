name: CI

on:
  push:
    branches: [main, develop, claude/**]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.12"

jobs:
  lint:
    name: Lint and Format Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy bandit[toml]
          pip install -e .[dev]

      - name: Run Ruff linter
        run: ruff check . --output-format=github

      - name: Run Ruff formatter check
        run: ruff format --check .

      - name: Run MyPy type checker
        run: mypy src/iam_looker --no-error-summary 2>&1 | head -100 || true
        continue-on-error: true

      - name: Run Bandit security scan
        run: bandit -r src/iam_looker -c pyproject.toml

  test:
    name: Test (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.12", "3.13"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]

      - name: Run unit tests with coverage
        run: |
          pytest -v -m "not integration" \
            --cov=src/iam_looker \
            --cov-report=xml \
            --cov-report=term \
            --cov-report=html
        env:
          LOOKERSDK_BASE_URL: "https://mock.looker.com"
          LOOKERSDK_CLIENT_ID: "mock_client_id"
          LOOKERSDK_CLIENT_SECRET: "mock_secret"
          LOOKERSDK_VERIFY_SSL: "false"

      - name: Upload coverage reports
        uses: codecov/codecov-action@v5
        if: matrix.python-version == '3.12'
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-${{ matrix.python-version }}
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload HTML coverage report
        uses: actions/upload-artifact@v4
        if: matrix.python-version == '3.12'
        with:
          name: coverage-report-html
          path: htmlcov/
          retention-days: 7

  test-cloud-functions:
    name: Test Cloud Functions Entry Points
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Test functions/main.py entry points
        run: |
          python -c "from functions.main import add_group_to_saml, create_project_folder, create_dashboard_from_template, provision_looker_project; print('All function imports successful')"

      - name: Test functions/main.py entry point
        run: |
          python -c "from functions.main import provision_looker_project; print('Cloud function import successful')"

      - name: Test CLI entry point
        run: |
          python -c "from iam_looker.cli import main; print('CLI import successful')"

      - name: Validate function payload handling
        run: |
          python functions/main.py '{"projectId":"test-project","groupEmail":"test@example.com"}'
        env:
          LOOKERSDK_BASE_URL: "https://mock.looker.com"
          LOOKERSDK_CLIENT_ID: "mock"
          LOOKERSDK_CLIENT_SECRET: "mock"

  terraform-validate:
    name: Terraform Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    defaults:
      run:
        working-directory: terraform

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.11.0"

      - name: Terraform Format Check
        run: terraform fmt -check -recursive

      - name: Terraform Init
        run: terraform init -backend=false

      - name: Terraform Validate
        run: terraform validate

      - name: Run terraform test
        run: terraform test || true
        continue-on-error: true

  terraform-security:
    name: Terraform Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: terraform
          framework: terraform
          output_format: cli,sarif
          output_file_path: console,results.sarif
          soft_fail: true
          quiet: true
          skip_check: CKV_GCP_1,CKV_GCP_6  # Common false positives

      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: results.sarif

  security-scan:
    name: Security & Dependency Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install safety pip-audit
          pip install -e .

      - name: Run Safety check
        run: safety check --json || true
        continue-on-error: true

      - name: Run pip-audit
        run: pip-audit --format json || true
        continue-on-error: true

      - name: Run Secret Scanning
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified

  build:
    name: Build Package
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [lint, test]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Build package
        run: python -m build

      - name: Check package
        run: twine check dist/*

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-packages-${{ github.sha }}
          path: dist/
          retention-days: 30

  build-cloud-function-artifact:
    name: Build Cloud Function Deployment Artifact
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [lint, test]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create deployment package
        run: |
          mkdir -p artifact
          cp -r src/ artifact/
          cp -r functions/ artifact/
          cp -r functions/ artifact/
          cp requirements.txt artifact/
          cp pyproject.toml artifact/

      - name: Create deployment zip
        run: |
          cd artifact
          zip -r ../cloud-function-deployment.zip .
          cd ..

      - name: Upload Cloud Function artifact
        uses: actions/upload-artifact@v4
        with:
          name: cloud-function-artifact-${{ github.sha }}
          path: cloud-function-deployment.zip
          retention-days: 30

  integration-test:
    name: Integration Tests (Optional)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [test]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]

      - name: Authenticate to Google Cloud
        if: github.event_name == 'push' && secrets.GCP_PROJECT_ID != ''
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Run integration tests
        if: github.event_name == 'push' && secrets.GCP_PROJECT_ID != ''
        run: |
          pytest -v -m integration
        env:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          LOOKERSDK_BASE_URL: ${{ secrets.LOOKERSDK_BASE_URL }}
          LOOKERSDK_CLIENT_ID: ${{ secrets.LOOKERSDK_CLIENT_ID }}
          LOOKERSDK_CLIENT_SECRET: ${{ secrets.LOOKERSDK_CLIENT_SECRET }}

  all-checks:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [lint, test, test-cloud-functions, terraform-validate, terraform-security, security-scan, build, build-cloud-function-artifact]
    if: always()

    steps:
      - name: Check job results
        run: |
          echo "Lint: ${{ needs.lint.result }}"
          echo "Test: ${{ needs.test.result }}"
          echo "Test Cloud Functions: ${{ needs.test-cloud-functions.result }}"
          echo "Terraform Validate: ${{ needs.terraform-validate.result }}"
          echo "Terraform Security: ${{ needs.terraform-security.result }}"
          echo "Security Scan: ${{ needs.security-scan.result }}"
          echo "Build: ${{ needs.build.result }}"
          echo "Build Cloud Function: ${{ needs.build-cloud-function-artifact.result }}"

          if [[ "${{ needs.lint.result }}" != "success" ]] || \
             [[ "${{ needs.test.result }}" != "success" ]] || \
             [[ "${{ needs.test-cloud-functions.result }}" != "success" ]] || \
             [[ "${{ needs.terraform-validate.result }}" != "success" ]] || \
             [[ "${{ needs.build.result }}" != "success" ]] || \
             [[ "${{ needs.build-cloud-function-artifact.result }}" != "success" ]]; then
            echo "❌ One or more required checks failed"
            exit 1
          fi
          echo "✅ All required checks passed!"
