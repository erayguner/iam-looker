name: CI - Security & Quality Checks

on:
  push:
    branches: [main, develop, claude/**]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  # Secret scanning with Gitleaks
  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

  # Python security and quality checks
  python-security:
    name: Python Security & Linting
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.12"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run Ruff linter
        run: |
          echo "::group::Ruff Linting"
          ruff check . --output-format=github
          echo "::endgroup::"

      - name: Run Ruff formatter check
        run: |
          echo "::group::Ruff Format Check"
          ruff format --check .
          echo "::endgroup::"

      - name: Run Bandit security scan
        run: |
          echo "::group::Bandit Security Scan"
          bandit -r src/ -f json -o bandit-report.json
          bandit -r src/ -f screen
          echo "::endgroup::"

      - name: Upload Bandit results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: bandit-security-report
          path: bandit-report.json

  # Terraform security scanning
  terraform-security:
    name: Terraform Security (Checkov)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Install Checkov
        run: pip install checkov

      - name: Run Checkov scan
        id: checkov
        run: |
          echo "::group::Checkov Security Scan"
          checkov -d terraform/ \
            --framework terraform \
            --output cli \
            --output json \
            --output-file-path checkov-results \
            --compact \
            --quiet || true
          echo "::endgroup::"

      - name: Upload Checkov results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: checkov-security-report
          path: checkov-results/

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.10.3

      - name: Terraform Format Check
        run: |
          echo "::group::Terraform Format Check"
          cd terraform
          terraform fmt -check -recursive
          echo "::endgroup::"

      - name: Terraform Init
        run: |
          echo "::group::Terraform Init"
          cd terraform
          terraform init -backend=false
          echo "::endgroup::"

      - name: Terraform Validate
        run: |
          echo "::group::Terraform Validate"
          cd terraform
          terraform validate
          echo "::endgroup::"

  # Dependency scanning
  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Install pip-audit
        run: pip install pip-audit

      - name: Run pip-audit
        run: |
          echo "::group::Pip-audit Vulnerability Scan"
          pip-audit --requirement requirements.txt --format json --output pip-audit-report.json || true
          pip-audit --requirement requirements.txt || true
          echo "::endgroup::"
        continue-on-error: true

      - name: Upload pip-audit results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: pip-audit-report
          path: pip-audit-report.json

  # Pre-commit checks
  pre-commit:
    name: Pre-commit Hooks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.10.3

      - name: Install pre-commit
        run: pip install pre-commit

      - name: Cache pre-commit
        uses: actions/cache@v5
        with:
          path: ~/.cache/pre-commit
          key: pre-commit-${{ hashFiles('.pre-commit-config.yaml') }}

      - name: Run pre-commit
        run: |
          echo "::group::Pre-commit Hooks"
          SKIP=terraform_validate pre-commit run --all-files --show-diff-on-failure
          echo "::endgroup::"

  # Python tests
  test:
    name: Python Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.12"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e ".[dev]"
          pip install pytest-cov

      - name: Run tests with coverage
        run: |
          echo "::group::Pytest with Coverage"
          pytest --cov=src --cov-report=xml --cov-report=term-missing --cov-report=html
          echo "::endgroup::"

      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: coverage-report
          path: |
            coverage.xml
            htmlcov/

      - name: Upload coverage to Codecov
        if: always()
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
        continue-on-error: true

  # SAST scanning with Semgrep
  sast-scan:
    name: SAST with Semgrep
    runs-on: ubuntu-latest
    container:
      image: semgrep/semgrep

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Run Semgrep
        run: |
          semgrep scan --config=auto \
            --json \
            --output=semgrep-results.json \
            --severity=ERROR \
            --severity=WARNING || true

      - name: Upload Semgrep results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: semgrep-results
          path: semgrep-results.json

  # CodeQL analysis
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read

    strategy:
      fail-fast: false
      matrix:
        language: ['python']

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: ${{ matrix.language }}
          queries: security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@v4

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:${{ matrix.language }}"

  # Security summary
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [secret-scan, python-security, terraform-security, dependency-scan, sast-scan]
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v7

      - name: Security Summary
        run: |
          echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Scans Completed:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Secret Scanning (Gitleaks)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Python Security (Bandit)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Infrastructure Security (Checkov)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Dependency Scanning (pip-audit)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… SAST Analysis (Semgrep)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š View detailed reports in the workflow artifacts." >> $GITHUB_STEP_SUMMARY
