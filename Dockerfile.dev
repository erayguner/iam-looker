# Development Dockerfile with all development tools
FROM python:3.12-slim

ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1 \
    PYTHONPATH="/app/src:$PYTHONPATH"

WORKDIR /app

# Install system dependencies including Terraform
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    git \
    curl \
    wget \
    unzip \
    make \
    gcc \
    g++ \
    && rm -rf /var/lib/apt/lists/*

# Install Terraform
ARG TERRAFORM_VERSION=1.10.3
RUN wget -q https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}/terraform_${TERRAFORM_VERSION}_linux_amd64.zip && \
    unzip terraform_${TERRAFORM_VERSION}_linux_amd64.zip -d /usr/local/bin/ && \
    rm terraform_${TERRAFORM_VERSION}_linux_amd64.zip && \
    terraform version

# Copy dependency files
COPY requirements.txt pyproject.toml ./

# Install Python dependencies (including dev dependencies)
RUN pip install --upgrade pip setuptools wheel && \
    pip install -r requirements.txt

# Install the package in editable mode with dev extras
COPY . .
RUN pip install -e ".[dev,terraform,all]"

# Install pre-commit hooks
RUN git config --global --add safe.directory /app && \
    pre-commit install --install-hooks || true

# Default command
CMD ["/bin/bash"]
